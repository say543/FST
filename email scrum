search gold 的兩個scrum
//depot/deploy/builds/data/answers/QasIpe01Ds/... //DESKTOP-3J7614O-searchgold-2/deploy/builds/data/answers/QasIpe01Ds/...
//depot/deploy/builds/data/answers/QAS12HttpQAS/... //DESKTOP-3J7614O-searchgold-2/deploy/builds/data/answers/QAS12HttpQAS/...
//depot/deploy/builds/data/local/email... //DESKTOP-3J7614O-searchgold-2/deploy/builds/data/local/email...


michael example 
QcsQueryLabelWithLes.exe -c D:\SearchGold\deploy\builds\data\Answers\QasIpe01Ds --variant Prod.email_enus_MV1  --verbose --legacyAllowUnusedParameters -dl email --encoding utf-8 --interactive --externalFeaturesColumn 2,9,16,23 --queryInColumn 1

change to meet old 我們舊的方式
其中一個column
.\QCSQueryLabelWithLES.exe --externalFeaturesColumn 2,9,16,23 --queryInColumn 1 --interactive --verbose --encoding utf-8 --legacyAllowUnusedParameters -c E:\SearchGold\deploy\builds\data\answers\QasIpe01Ds  --variant Prod.email_enus_MV1 -dl email

prod.email_enus_mv1
這個是ini 的name

<temporary problem>
06262091
p.s 目前只能用QAS12HttpQAS, not QasIpe01Ds
p.s model file 要用這個 email_enus_MV1
.\QCSQueryLabelWithLES.exe --externalFeaturesColumn 2,9,16,23 --queryInColumn 1 --interactive --verbose --encoding utf-8 --legacyAllowUnusedParameters -c E:\SearchGold\deploy\builds\data\answers\QAS12HttpQAS  --variant email_enus_MV1 -dl email


email 的bing intent
carina bing intent

可以測production 的environment
p.s 這個email thread 有簡單的教學 for bing intent
RE: Regression: LU no longer returning PersonalMediaTitle information for Speaker queries (Desktop/Xbox work fine)

carina/binginent 
https://carina/bingintent
選Bed
exg: HttpQAS-Prod
virtual service 
CortanaLU
data set 選我們自己的column
QAS12HttpQAS
client
Microsoft_Threshold_Shell_3_enus_CortanaSDK

怎麼multi turn result 不太確定  之後看



pattern 所在的位置
在search gold 的下面
deploy/builds/data/local/email

其中一個
email.message_type.partial.pattern.tagger.partial.txt



========================
multi -turn query test
https://msasg.visualstudio.com/Cortana/_workitems/edit/1863645
========================

flag conversations\tPreviousTurnIntent\t0\t1\tsearch_email\t1.0\t-1\t-1\tPreviousTurnDomain\t0\t1\temail\t1.0\t-1\t-1

參照這個flag single 的output flag 因該是要message type
flag conversation\tPreviousTurnIntent\t0\t1\tsearch_email\t1.0\t-1\t-1\tPreviousTurnDomain\t0\t1\temail\t1.0\t-1\t-1

format 說明
PreviousTurnDomain\t0\t1\temail\t1.0\t-1\t-1
第一個0 忘記是什麼?
第一個1 代表
number of string features
1代表後面 一個 triple
1.0 : wegiht
[-1 , -1] index 的span
Inputs:
    ExternalInput6 (tag: 0, string: 1)
      email[-1,-1]=1
      
    這邊的email 是string
    ? 怎麼轉的  裡面可能會在自己轉


p.s 跟實際的MLG processor format很similar 但是這邊的a 是tag id 
a[b,c] = d
a: tag id
b,c  index 
d : weight
參照這個link
https://msasg.visualstudio.com/QAS/_git/qas?path=%2Fprivate%2Fanswers%2FSDS%2FQCS%2Flib%2Fsrc%2Fmlg3.4%2Fdoc%2FFeatureSetFilter.md&version=GBmaster




if 要用 carina bingintet
加上
ClientContext_ReferenceTime / 2019-06-26T16:20:27
PreviousTurnIntent / search_email
PreviousTurnDomain / email

Bed: HttpQas-Prod
VirtualService : CortanaLU
DataSet: QAS12HttpQAS
ClientId: Microsoft_Threshold_Shell_3_enus_CortanaSDK


flag conversaion 的featurizer 的 trace 討論:
[qd_cortana_email_enus_MV1_slots_lccrf_featurizer]
[qd_cortana_email_enus_MV1_slots_partial_pattern_featurizer]
[qd_cortana_email_enus_MV1_slots_pattern_featurizer]
[qd_cortana_email_enus_MV1_slots_pattern_override_featurizer]
[qd_cortana_email_enus_MV1_slots_pattern_restore_featurizer]
沒tag 正確slot


[qd_cortana_email_enus_MV1_slots_hotfix_featurizer]
直接apply hotfix 的files 當作wihte list
出現21
用到hotfix
cortana_email_enus_MV1.slots.hotfix.txt


based on format
https://microsoft.sharepoint.com/teams/LUforNextgenAgents/_layouts/15/WopiFrame.aspx?sourcedoc={68deb809-671e-469a-be79-ba53c05298ce}&action=edit&wd=target%28CLU%20DRI.one%7C1990f4e6-5d06-4429-8ee9-ba6b20b33107%2FExact%20match%20hotfix%20file%20format%7Ce81245d4-55ea-458a-aaf1-036d8c0817f5%2F%29

flag conversation	cortana_email_enus_MV1_slots_hotfix	
(#number of kokens, 0)
2	0	
(#slotid #weight #token_index  #token_index)
0	1	0	0	21	1	1	1

根據cortana_email_enus_MV1.slots.entities.Config
(用在 qd_cortana_email_enus_MV1_slots_queryparser 的slot 的最後一個)
21 就是message type

p.s 這邊似乎first turn or second turn hotfix 都會作用
    if 如果是first turn domain score 不會win  因為web 很高  所以沒有作用  
        QAS intent output
        email.multiclass.output.txt output:
        flag conversation       email_other     1
        
        QAS domain output 
        form [qd_cortana_email_enus_MV1_domain_domainclassifier]
        email.maxent.output.txt output:
        flag conversation       0.28588
        
        trace back
        [qd_email_domain_intent_last_eval_featurizer]
        [qd_email_domain_query_hotfix_override_featurizer]
        [qd_email_domain_pattern_override_featurizer]
        [qd_email_domain_hotfix_featurizer]
             from email_domain_intent:ExternalInput2
             
        externalinput 以經有0.28588
        
        [qd_email_domain_featurizer]
              有multi turn logic  by comment
              有previousturn doamin 的as ExternalInput6
              
              7: MlgFeaturizer --in=ExternalInput6 --out=emailPreviousDomainTemp --fts=email.previousTurnDomain.bin
              Inputs:
                ExternalInput6 (tag: 0, string: 0)
              Output:
                emailPreviousDomainTemp (tag: 0, string: 0)
              沒有東西
              
              裡面也有multi turn logic
              from email:cortana_email_enus_MV1_domain_hotfix:ExternalInput1
              0.23588
              加上shifty 0.05
              0.28588
        [qd_cortana_email_enus_MV1_domain_hotfix_override_featurizer]
        [qd_cortana_email_enus_MV1_domain_pattern_override_featurizer]
        [qd_cortana_email_enus_MV1_domain_svm_featurizer]
              0.23588 的來源
              是這個svm 的model train 出來的
        
    if multi turn
        QAS intent output
        email.multiclass.output.txt output:
        flag conversation       flag     1
        
        QAS domain output 
        form [qd_cortana_email_enus_MV1_domain_domainclassifier]
        email.maxent.output.txt output:
        flag conversation       1
        
        trace back
        [qd_email_domain_intent_last_eval_featurizer]
        [qd_email_domain_query_hotfix_override_featurizer]
        [qd_email_domain_pattern_override_featurizer]
        [qd_email_domain_hotfix_featurizer]
             from email_domain_intent:ExternalInput2
             
        externalinput 以經有0.28588
        
        [qd_email_domain_featurizer]
              有multi turn logic  by comment
              有previousturn doamin 的as ExternalInput6
              
        [qd_email_domain_intent_last_eval_featurizer]
        [qd_email_domain_query_hotfix_override_featurizer]
        [qd_email_domain_pattern_override_featurizer]
        [qd_email_domain_hotfix_featurizer]
             from email_domain_intent:ExternalInput2
             
        externalinput 以經有0.28588
        
        [qd_email_domain_featurizer]
              有previousturn doamin 的as ExternalInput6
              
               7: MlgFeaturizer --in=ExternalInput6 --out=emailPreviousDomainTemp --fts=email.previousTurnDomain.bin
               Inputs:
                ExternalInput6 (tag: 0, string: 1)
                        email[-1,-1]=1
               Output:
                 emailPreviousDomainTemp (tag: 1, string: 0)
                        0[0,0]=1
                        
                27: FeatureSetFilter --in=OneConf,isConfirmIntent2,OneConf,email_domain_intent_boost,OneConf,ShouldBoostDomainConf,OneConf,email_domain_intent_slot_boost --out=email_domain_intent --filterTagId=0 --filterWeight=0.1 --keepTagFeatures=1 --maxOutFeatureSets=1
                Inputs:
                OneConf (tag: 1, string: 0)
                        0[-1,-1]=1
                isConfirmIntent2 (tag: 1, string: 0)
                        0[-1,-1]=0  v.s 0[-1,-1]=-1 (single turn)
                OneConf (tag: 1, string: 0)
                        0[-1,-1]=1
                email_domain_intent_boost (tag: 1, string: 0)
                        0[-1,-1]=1 v.s 0[-1,-1]=0 (single turn)
                OneConf (tag: 1, string: 0)
                        0[-1,-1]=1
                ShouldBoostDomainConf (tag: 1, string: 0)
                        0[-1,-1]=0
                OneConf (tag: 1, string: 0)
                        0[-1,-1]=1
                email_domain_intent_slot_boost (tag: 1, string: 0)
                        0[-1,-1]=0 v.s 0[-1,-1]=-2 (single turn)
                Output:
                email_domain_intent (tag: 1, string: 0)
                        0[-1,-1]=1  v.s 0[-1,-1]=0.28588 (single turn)
                multi turn 的 domain score 會override email_domain_intent  (所以後面會override 前面的?)
                參照 'QAS component' 似乎任何一個pair<ele1, ele2> 符合  都可以把OneConf  輸出到結果
                ele2 (isConfirmIntent2, email_domain_intent_boost,  ShouldBoostDomainConf,  email_domain_intent_slot_boost) 似乎是exclusive 的概念
                
              
              裡面也有multi turn logic
              from email:cortana_email_enus_MV1_domain_hotfix:ExternalInput1
              0.23588
              加上shifty 0.05
              0.28588
        [qd_cortana_email_enus_MV1_domain_hotfix_override_featurizer]
        [qd_cortana_email_enus_MV1_domain_pattern_override_featurizer]
        [qd_cortana_email_enus_MV1_domain_svm_featurizer]
              0.23588 的來源
              是這個svm 的model train 出來的
              
              裡面也有multi turn logic
              from email:cortana_email_enus_MV1_domain_hotfix:ExternalInput1
              0.23588
              加上shifty 0.05
              0.28588
        [qd_cortana_email_enus_MV1_domain_hotfix_override_featurizer]
        [qd_cortana_email_enus_MV1_domain_pattern_override_featurizer]
        [qd_cortana_email_enus_MV1_domain_svm_featurizer]
              0.23588 的來源
              是這個svm 的model train 出來的


[qd_email_mapIntentAndSlots_featurizer]
用到file
email.slots.mapping_to.20180702.txt
21 還是到21

[qd_email_slots_featurizer]
'andle multi-turn slot override'
也有multi turn 得slot 功能
但是21還是21

[qd_email_slots_hotfix_featurizer]
qd_email_slots_partial_pattern_featurizer
qd_email_slots_pattern_override_featurizer
qd_email_slots_pattern_restore_featurizer
qd_email_slots_query_hotfix_override_featurizer
qd_email_mapIntentAndSlotsBack_featurizer
還是21 沒有改變
這妹

[qd_email_slots_partial_pattern_featurizer]
from 
[featurizer3011 = qd_email_slots_partial_pattern_featurizer]

21 還是
from ExternalInput2 
from  email:email_slots_hotfix:ExternalInput2  [qd_email_slots_hotfix_featurizer]




flag conversaions 的featurizer 的 trace 討論:
    if 如果是first turn domain score 不會win  因為web 很高  所以沒有作用  
        QAS intent output
        email.multiclass.output.txt output:
        flag conversation       email_other     1
        
        QAS domain output 
        form [qd_cortana_email_enus_MV1_domain_domainclassifier]
        email.maxent.output.txt output:
        flag conversation       0.303262

        [qd_cortana_email_enus_MV1_slots_lccrf_featurizer]
        這邊crf 就已經tag flag as message_category 是目前錯誤的來源
   
    if multi turn
        QAS intent output
        email.multiclass.output.txt output:
        flag conversation       flag     1
        
        QAS domain output 
        form [qd_cortana_email_enus_MV1_domain_domainclassifier]
        email.maxent.output.txt output:
        flag conversation       1
    [qd_cortana_email_enus_MV1_slots_lccrf_featurizer]
    [qd_cortana_email_enus_MV1_slots_partial_pattern_featurizer]
    [qd_cortana_email_enus_MV1_slots_pattern_featurizer]
    [qd_cortana_email_enus_MV1_slots_pattern_override_featurizer]
    [qd_cortana_email_enus_MV1_slots_pattern_restore_featurizer]
    [qd_cortana_email_enus_MV1_slots_hotfix_featurizer]
    [qd_cortana_email_enus_MV1_slots_hotfix_override_featurizer]
        會tag flag as 13 message_category
    
    [qd_email_mapIntentAndSlots_featurizer]
        for slot
        會把13 轉成 1
        ? 不知道這個功能是什麼
        
        主要是用了舊的carina model
        ;; Old Carina Model
        /domain /intent/ slot
        ....
        
        最後用這個轉回來
        [qd_email_mapIntentAndSlotsBack_featurizer]


flag the email 的featurizer 的 trace 討論:
    [qd_cortana_email_enus_MV1_slots_lccrf_featurizer]
    [qd_cortana_email_enus_MV1_slots_partial_pattern_featurizer]
    [qd_cortana_email_enus_MV1_slots_pattern_featurizer]
    [qd_cortana_email_enus_MV1_slots_pattern_override_featurizer]
    [qd_cortana_email_enus_MV1_slots_pattern_restore_featurizer]
    [qd_cortana_email_enus_MV1_slots_hotfix_featurizer]
    [qd_cortana_email_enus_MV1_slots_hotfix_override_featurizer]
        會tag flag as 13 message_category
    
    [qd_email_mapIntentAndSlots_featurizer]
    [qd_email_slots_featurizer]
    [qd_email_slots_hotfix_featurizer]
     這個會新增emall as 21 message_type
     是用pattern file
     email.message_type.partial.pattern.tagger.partial.txt
     
     會把13 轉成1 不太懂   
